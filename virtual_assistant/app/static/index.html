<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .task-card { transition: transform 0.2s; }
        .task-card:hover { transform: translateY(-5px); }
        .status-pending { border-left: 5px solid #ffc107; }
        
        /* Pulse animation for recording state */
        .recording {
            animation: pulse 1.5s infinite;
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
    </style>
</head>
<body class="container py-5">

    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5 fw-bold text-primary">Virtual Assistant</h1>
            <p class="lead">Your AI-powered daily scheduler.</p>
        </div>
        <div class="col-auto align-self-center">
            <button class="btn btn-outline-primary" onclick="loadTasks()">Refresh Schedule</button>
        </div>
    </div>

    <div class="card shadow-sm mb-5">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Add New Task</h5>
                <button id="micBtn" onclick="startListening()" class="btn btn-danger btn-sm rounded-pill px-3">
                    üé§ Speak Task
                </button>
            </div>

            <div class="row g-2">
                <div class="col-md-3">
                    <input type="time" id="taskTime" class="form-control" required>
                </div>
                <div class="col-md-5">
                    <input type="text" id="taskTitle" class="form-control" placeholder="Task Name (e.g., Check Emails)" required>
                </div>
                 <div class="col-md-2">
                    <select id="taskCategory" class="form-select">
                        <option value="General">General</option>
                        <option value="PhD">PhD</option>
                        <option value="App">App Dev</option>
                        <option value="Personal">Personal</option>
                    </select>
                </div>
                <div class="col-md-2 d-grid">
                    <button onclick="addTask()" class="btn btn-primary">Add Task</button>
                </div>
            </div>
            
            <p id="voiceStatus" class="text-muted small mt-2 fst-italic" style="display:none;">Listening...</p>
        </div>
    </div>

    <h3 class="mb-3">Today's Schedule</h3>
    <div id="taskList" class="row row-cols-1 row-cols-md-2 g-4">
        </div>

    <script>
        const API_URL = ""; 

        // --- CORE FUNCTIONS ---

        async function loadTasks() {
            const response = await fetch(`${API_URL}/today-tasks`);
            const tasks = await response.json();
            const container = document.getElementById('taskList');
            container.innerHTML = '';

            tasks.sort((a, b) => a.time.localeCompare(b.time));

            tasks.forEach(task => {
                const card = `
                <div class="col">
                    <div class="card h-100 shadow-sm task-card status-pending">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h4 class="card-title mb-0">${task.title}</h4>
                                <span class="badge bg-secondary">${task.time}</span>
                            </div>
                            <p class="text-muted small">Category: ${task.category || 'General'}</p>
                            
                            <hr>
                            <div class="d-flex gap-2">
                                <button onclick="sendFeedback('${task.title}', '${task.time}', 'done', '${task.category || 'General'}')" class="btn btn-success btn-sm flex-grow-1">‚úÖ Done</button>
                                <button onclick="sendFeedback('${task.title}', '${task.time}', 'skipped', '${task.category || 'General'}')" class="btn btn-danger btn-sm flex-grow-1">‚è≠ Skip</button>
                            </div>
                        </div>
                    </div>
                </div>`;
                container.innerHTML += card;
            });
        }

        async function addTask() {
            const time = document.getElementById('taskTime').value;
            const title = document.getElementById('taskTitle').value;
            const category = document.getElementById('taskCategory').value;

            if (!time || !title) {
                alert("Please fill in time and title");
                return;
            }

            const res = await fetch(`${API_URL}/add-task?time=${time}&title=${title}&category=${category}`, {
                method: 'POST'
            });

            if (res.ok) {
                // Clear inputs
                document.getElementById('taskTitle').value = '';
                loadTasks();
            } else {
                const err = await res.json();
                alert("Error: " + err.detail);
            }
        }

        async function sendFeedback(task, time, status, category) {
            const url = `${API_URL}/task-feedback?task=${encodeURIComponent(task)}&planned_time=${time}&response_type=${status}&category=${category}`;
            await fetch(url, { method: 'POST' });
            loadTasks(); 
        }

        // --- VOICE RECOGNITION LOGIC ---

        function startListening() {
            const status = document.getElementById('voiceStatus');
            const btn = document.getElementById('micBtn');
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                alert("Your browser does not support voice recognition. Try Chrome, Edge, or Safari.");
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US';
            recognition.start();

            // UI Updates
            status.style.display = 'block';
            status.innerText = "Listening... Speak now (e.g., 'Review Paper')";
            btn.classList.add("recording");
            btn.innerText = "Listening...";

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                
                // 1. Fill the title
                document.getElementById('taskTitle').value = transcript;
                
                // 2. Auto-set time to 5 mins from now (Convenience feature)
                const now = new Date();
                const future = new Date(now.getTime() + 5*60000);
                const hours = String(future.getHours()).padStart(2, '0');
                const minutes = String(future.getMinutes()).padStart(2, '0');
                document.getElementById('taskTime').value = `${hours}:${minutes}`;

                status.innerText = `Heard: "${transcript}"`;
            };

            recognition.onspeechend = function() {
                recognition.stop();
                resetMicUI();
            };
            
            recognition.onerror = function(event) {
                status.innerText = "Error: " + event.error;
                resetMicUI();
            };

            function resetMicUI() {
                btn.classList.remove("recording");
                btn.innerText = "üé§ Speak Task";
                setTimeout(() => status.style.display = 'none', 4000);
            }
        }

        // Initial Load
        loadTasks();

        // --- TEXT TO SPEECH POLLING ---
        
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            // Optional: Choose a voice
            // const voices = window.speechSynthesis.getVoices();
            // utterance.voice = voices[0]; 
            window.speechSynthesis.speak(utterance);
        }

        async function checkNotifications() {
            try {
                const res = await fetch(`${API_URL}/notifications`);
                const messages = await res.json();
                
                if (messages.length > 0) {
                    messages.forEach(msg => speak(msg));
                    // Refresh list to show the task is due
                    loadTasks(); 
                }
            } catch (e) {
                console.log("Polling error", e);
            }
        }

        // Check for notifications every 5 seconds
        setInterval(checkNotifications, 5000);
    </script>
</body>
</html>